{% extends "base.html" %}

{% block content %}
<div class="container py-5" style="max-width: 700px;">
    <h2 class="mb-4 text-center">{{ _('Configuración del grupo') }}</h2>

    <form method="post" action="/groups/create-group" id="settingsForm">
        <!-- Hidden values from previous step -->
        <input type="hidden" name="state_number" value="{{ state_number }}">
        <input type="hidden" name="group_code" value="{{ group_code }}">

        <!-- Número de alianzas -->
        <div class="mb-4">
            <label for="numAlliances" class="form-label">{{ _('Número de alianzas (1 a 12)') }}</label>
            <select id="numAlliances" name="num_alliances" class="form-select" onchange="renderAllianceFields()">
                <option value="">{{ _('Selecciona una opción') }}</option>
                {% for i in range(1, 13) %}
                    <option value="{{ i }}">{{ i }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Campos de nombres de alianzas -->
        <div id="alliancesContainer" class="mb-4"></div>

        <!-- Número de días -->
        <div class="mb-4">
            <label for="numDays" class="form-label">{{ _('Número de días a organizar (1 a 4)') }}</label>
            <select id="numDays" name="num_days" class="form-select" onchange="renderDayFields()">
                <option value="">{{ _('Selecciona una opción') }}</option>
                {% for i in range(1, 5) %}
                    <option value="{{ i }}">{{ i }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Campos de nombres de días -->
        <div id="daysContainer" class="mb-4"></div>

        <!-- Botones -->
        <div class="text-center d-flex justify-content-center gap-3">
            <button id="confirmButton" type="submit" class="btn btn-primary" disabled>
                {{ _('Confirmar configuración') }}
            </button>

            {% if not from_creation %}
            <a href="/groups/view/{{ group.group_code }}" class="btn btn-secondary">
                {{ _('Cancelar') }}
            </a>
            {% endif %}
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
function renderAllianceFields() {
    const selectedValue = document.getElementById('numAlliances').value;
    const count = parseInt(selectedValue);
    const container = document.getElementById('alliancesContainer');
    container.innerHTML = '';

    if (isNaN(count) || count < 1) {
        updateConfirmButton();
        return;
    }

    for (let i = 1; i <= count; i++) {
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'form-control mb-2 alliance-field';
        input.placeholder = `{{ _('Alianza') }} ${i} (3 {{ _('caracteres') }})`;
        input.maxLength = 3;
        input.required = true;
        input.name = `alliance_${i}`;
        input.oninput = updateConfirmButton;
        container.appendChild(input);
    }

    const otherInput = document.createElement('input');
    otherInput.type = 'text';
    otherInput.className = 'form-control mb-2';
    otherInput.placeholder = `{{ _('Otra') }} ({{ _('Alianza adicional no editable') }})`;
    otherInput.readOnly = true;
    container.appendChild(otherInput);

    updateConfirmButton();
}

function renderDayFields() {
    const count = parseInt(document.getElementById('numDays').value) || 0;
    const container = document.getElementById('daysContainer');
    container.innerHTML = '';

    for (let i = 1; i <= count; i++) {
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'form-control mb-2 day-field';
        input.placeholder = `{{ _('Nombre del día') }} ${i} (Ej: VP Monday)`;
        input.maxLength = 30;
        input.required = true;
        input.name = `day_${i}`;
        input.oninput = updateConfirmButton;
        container.appendChild(input);
    }

    updateConfirmButton();
}

function updateConfirmButton() {
    const allianceInputs = document.querySelectorAll('.alliance-field');
    const dayInputs = document.querySelectorAll('.day-field');
    const confirmBtn = document.getElementById('confirmButton');

    const allAlliancesFilled = Array.from(allianceInputs).every(input => input.value.trim() !== '');
    const allDaysFilled = Array.from(dayInputs).every(input => input.value.trim() !== '');

    const alliancesValid = allianceInputs.length > 0;
    const daysValid = dayInputs.length > 0;

    confirmBtn.disabled = !(alliancesValid && daysValid && allAlliancesFilled && allDaysFilled);
}
</script>
{% endblock %}
