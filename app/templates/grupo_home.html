{% extends "base.html" %}

{% block content %}
<div class="container">

    <div class="d-flex mb-2 mt-3">
        <a href="/groups/my-groups" class="btn btn-outline-secondary btn-sm">
            ‚Üê {{ _('Volver') }}
        </a>
    </div>
    <!-- Encabezado del grupo -->
     
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3 p-3 border-bottom">
        <!-- Informaci√≥n del grupo -->
        <div>
            <h2 class="mb-2">{{ _('Estado') }} {{ group.state_number }}</h2>
            <p class="mb-0">{{ _('C√≥digo del estado:') }} <strong>{{ group.group_code }}</strong></p>
        </div>
    
        <!-- Botones agrupados por funcionalidad -->
        <div class="d-flex gap-2">
            {% if is_creator %}
            <!-- Bot√≥n desplegable de Administraci√≥n -->
            <div class="dropdown">
                <button class="btn btn-primary dropdown-toggle" type="button" id="adminDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-gear-fill me-1"></i> {{ _('Administrar') }}
                </button>
                <ul class="dropdown-menu shadow border-0" aria-labelledby="adminDropdown">
                    <li>
                        <a class="dropdown-item d-flex align-items-center" href="#" data-bs-toggle="modal" data-bs-target="#modalGestionMiembros" id="btnEditarMiembros">
                            <i class="bi bi-people me-2 text-primary"></i> {{ _('Gestionar editores') }}
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item d-flex align-items-center" href="#" data-bs-toggle="modal" data-bs-target="#ajustesModal">
                            <i class="bi bi-sliders me-2 text-primary"></i> {{ _('Configuraci√≥n') }}
                        </a>
                    </li>
                </ul>
            </div>
            {% endif %}
    
            <!-- Bot√≥n desplegable de Acciones del grupo -->
            <div class="dropdown">
                <button class="btn {% if is_creator %}btn-outline-danger{% else %}btn-danger{% endif %} dropdown-toggle" type="button" id="groupActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-three-dots-vertical me-1"></i> {{ _('Acciones') }}
                </button>
                <ul class="dropdown-menu shadow border-0" aria-labelledby="groupActionsDropdown">
                    <li>
                        <a class="dropdown-item d-flex align-items-center text-danger" href="#" data-bs-toggle="modal" data-bs-target="#leaveGroupModal">
                            <i class="bi bi-box-arrow-right me-2"></i> {{ _('Abandonar grupo') }}
                        </a>
                    </li>
                    {% if is_creator %}
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <a class="dropdown-item d-flex align-items-center text-danger" href="#" data-bs-toggle="modal" data-bs-target="#modalEliminarGrupo">
                            <i class="bi bi-trash me-2"></i> {{ _('Eliminar grupo') }}
                        </a>
                    </li>
                    {% endif %}

                </ul>
            </div>
        </div>
    </div>


    <button class="btn btn-outline-primary btn-sm my-3" data-bs-toggle="modal" data-bs-target="#modalLinkCita">
        <i class="bi bi-link-45deg me-1"></i> Obtener link de postulaci√≥n
    </button>
    

    
    <!-- Cuerpo del grupo -->

    <div class="mt-4">
        <h4 class="mb-4">üìã {{ _('Postulaciones y asignaci√≥n') }}</h4>
    
        <!-- Tabs por d√≠a -->
        <ul class="nav nav-tabs" id="dayTabs" role="tablist">
            {% for day in group.days %}
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if loop.first %}active{% endif %}"
                        id="tab-{{ day.id }}"
                        data-bs-toggle="tab"
                        data-bs-target="#content-{{ day.id }}"
                        type="button"
                        role="tab"
                        aria-controls="content-{{ day.id }}"
                        aria-selected="{{ 'true' if loop.first else 'false' }}">
                    {{ day.name }}
                </button>
            </li>
            {% endfor %}
        </ul>
    
        <!-- Contenido de cada d√≠a -->
        <div class="tab-content border border-top-0 p-3">
            {% for day in group.days %}
            <div class="tab-pane fade {% if loop.first %}show active{% endif %}"
                    id="content-{{ day.id }}"
                    role="tabpanel"
                    aria-labelledby="tab-{{ day.id }}">

                
                {% set asignaciones_guardadas = assignments_by_day.get(day.id, []) %}

                <!-- T√≠tulo y bot√≥n -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>{{ _('Solicitudes:') }}</h5>
                </div>
                <!-- Link a ver todo -->
                <div class="my-2 text-start">
                    <a href="/groups/postulaciones/{{ day.id }}" class="btn btn-warning btn-sm">
                        {{ _('Ver/Eliminar postulaciones') }}
                    </a>
                </div>
    
                {% if day.submissions|length > 0 %}
                <!-- Tabla previa -->
                <div class="position-relative overflow-hidden rounded border" style="max-height: 185px;">
                    <table class="table table-sm table-bordered mb-0 text-center">
                        <thead class="table-light">
                            <tr>
                                <th>Alianza</th>
                                <th>Nombre</th>
                                <th>Speedups</th>
                                <th>Citas deseables</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sub in day.submissions[:3] %}
                            <tr>
                                <td>[{{ sub.alliance.name }}]</td>
                                <td>{{ sub.nickname }}</td>
                                <td>{{ sub.speedups }}</td>
                                <td>
                                    {% for slot in sub.availability %}
                                        {{ "%02d:%02d" | format(slot.start_time.hour, slot.start_time.minute) }} -
                                        {{ "%02d:%02d" | format(slot.end_time.hour, slot.end_time.minute) }}
                                        {% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
    
                    <!-- Gradiente -->
                    <div class="position-absolute bottom-0 start-0 w-100" style="height: 40px; pointer-events: none; z-index: 1;">
                        <div data-theme="light" style="height: 100%; background: linear-gradient(to bottom, transparent, var(--light-bg));"></div>
                        <div data-theme="dark" style="height: 100%; background: linear-gradient(to bottom, transparent, var(--dark-bg)); display: none;"></div>
                    </div>
                </div>


                {% else %}
                <p class="text-theme-muted">No hay postulaciones a√∫n para este d√≠a.</p>
                {% endif %}

                <hr class="mb-4"/>

                <!-- T√≠tulo -->
                <div class="d-flex justify-content-between align-items-center">
                    <h5>{{ _('Horario:') }}</h5>
                </div>

                <!-- L√≠mite de cupos por alianza -->
                <div class="mt-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="switchLimite-{{ day.id }}" onchange="toggleLimits('{{ day.id }}')">
                        <label class="form-check-label" for="switchLimite-{{ day.id }}">
                            {{ _('Definir n√∫mero de asignaciones por alianza') }}
                        </label>
                    </div>
                
                    <div class="row g-3 align-items-end d-none" id="limitesContainer-{{ day.id }}">
                        {% for a in alliances_serializable %}
                        <div class="col-md-3 col-sm-6">
                            <label for="limit_{{ day.id }}_{{ a.id }}" class="form-label">[{{ a.name }}]</label>
                            <select class="form-select form-select-sm limit-selector" 
                                    name="limit_{{ day.id }}_{{ a.id }}" 
                                    id="limit_{{ day.id }}_{{ a.id }}" 
                                    data-day="{{ day.id }}"
                                    onchange="handleLimitChange('{{ day.id }}')">
                                <option value="">{{ _('Sin l√≠mite') }}</option>
                                <option value="0">üö´ {{ _('Excluir esta alianza') }}</option>
                                {% for i in range(1, 49) %}
                                    <option value="{{ i }}">{{ i }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endfor %}
                    </div>
                </div>



                <button class="btn btn-primary my-3"
                    onclick="runAssign('{{ day.id }}')"
                    data-bs-toggle="modal"
                    data-bs-target="#modalAsignaciones-{{ day.id }}"
                    {% if day.submissions|length == 0 %}disabled{% endif %}>
                    {{ _('Generar nuevo horario') }}
                </button>
    


                <!-- Modal Nuevo horario por algoritmo -->
                <div class="modal fade" id="modalAsignaciones-{{ day.id }}" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-xl modal-dialog-scrollable">
                        <div class="modal-content glassmorphic">
                            <div class="modal-header">
                                <h5 class="modal-title">‚è±Ô∏è {{ _('Propuesta de asignaciones para') }} {{ day.name }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                            </div>
                            <div class="modal-body">
                
                                <!-- Lista de no asignados -->
                                <div class="mb-4">
                                    <h6>üö´ No asignados</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered text-center">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Alianza</th>
                                                    <th>Nombre</th>
                                                    <th>ID</th>
                                                    <th>Speedups</th>
                                                    <th>Disponibilidad</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tabla-no-asignados-{{ day.id }}">
                                                <!-- Rellenado din√°micamente -->
                                            </tbody>
                                        </table>
                                    </div>                                    
                                </div>
                
                                <!-- Tabla de asignaciones -->
                                <div class="table-responsive">
                                    <h6>‚úÖ {{ _('Propuesta √≥ptima de asignaci√≥n de horarios') }}
                                    </h6>
                                    <table class="table table-sm table-striped border text-center">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Hora (UTC)</th>
                                                <th>Alianza</th>
                                                <th>Nombre</th>
                                                <th>ID</th>
                                                <th>Speedups</th>
                                                <th>Disponibilidad</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabla-asignaciones-{{ day.id }}"></tbody>
                                    </table>
                                </div>
                
                            </div>
                            <div class="modal-footer">
                                <button type="button"
                                        class="btn btn-success"
                                        data-day-id="{{ day.id }}"
                                        data-has-assignments="{{ 'true' if assignments_by_day.get(day.id) else 'false' }}"
                                        onclick="confirmarGuardarAsignaciones(this)">
                                    Guardar asignaciones
                                </button>

                                <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">
                                    Cerrar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Modal de confirmacion remplazar informacion actual -->
                <div class="modal fade" id="confirmModal-{{ day.id }}" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content glassmorphic border border-danger">
                            <div class="modal-header">
                                <h5 class="modal-title text-danger">¬øSobrescribir asignaciones?</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                            </div>
                            <div class="modal-body">
                                Ya existen asignaciones guardadas para este d√≠a. ¬øDeseas reemplazarlas con la nueva propuesta?
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button class="btn btn-danger" onclick="guardarAsignaciones('{{ day.id }}', true)">
                                    S√≠, sobrescribir
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                

                <!-- Mostrar asignaciones guardadas en BD -->
                <div class="mt-4">
                    <h6>üìå {{ _('√öltimas asignaciones guardadas') }}</h6>
                
                    {% if asignaciones_guardadas %}
                    
                    <!-- Tabla de NO asignados -->
                    {% set no_asignados = no_asignados_by_day.get(day.id, []) %}
                    {% if no_asignados %}
                    <div class="table-responsive mb-4">
                        <h6>üö´ {{ _('No asignados (guardados)') }}</h6>
                        <table class="table table-sm table-bordered text-center">
                            <thead class="table-light">
                                <tr>
                                    <th>Alianza</th>
                                    <th>Nombre</th>
                                    <th>ID</th>
                                    <th>Speedups</th>
                                    <th>Disponibilidad</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for u in no_asignados %}
                                <tr>
                                    <td>[{{ u.alliance }}]</td>
                                    <td>{{ u.nickname }}</td>
                                    <td>{{ u.ingame_id or '-' }}</td>
                                    <td>{{ u.speedups }}</td>
                                    <td>{{ u.availability_str }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                
                    <!-- Tabla de asignaciones por bloque horario -->
                    <div class="table-responsive mb-3">
                        <h6>‚úÖ {{ _('Asignaciones guardadas por horario') }}</h6>
                        <table class="table table-sm table-striped border text-center">
                            <thead class="table-light">
                                <tr>
                                    <th>Hora (UTC)</th>
                                    <th>Alianza</th>
                                    <th>Nombre</th>
                                    <th>ID</th>
                                    <th>Speedups</th>
                                    <th>Disponibilidad</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set asignaciones_map = asignaciones_guardadas | map(attribute="hour_block") | list %}
                                {% for b in range(48) %}
                                    {% set a = asignaciones_guardadas | selectattr("hour_block", "equalto", b) | list | first %}
                                    <tr class="{{ 'table-secondary' if not a or not a.nickname }}">
                                        <td><strong>{{ "%02d:%02d"|format((b // 2), (30 if b % 2 else 0)) }}</strong></td>
                                        {% if a and a.nickname %}
                                            <td>[{{ a.alliance }}]</td>
                                            <td>{{ a.nickname }}</td>
                                            <td>{{ a.ingame_id or '-' }}</td>
                                            <td>{{ a.speedups }}</td>
                                            <td>{{ a.availability_str }}</td>
                                        {% else %}
                                            <td colspan="5"><em>‚Äî Sin asignaci√≥n ‚Äî</em></td>
                                        {% endif %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                
                    {% else %}
                    <div class="alert alert-info text-center mt-3" role="alert">
                        {{ _('A√∫n no hay asignaciones guardadas para este d√≠a.') }}
                    </div>
                    {% endif %}
                </div>
                
                
                
                
    
                <!-- Aqu√≠ continua la secci√≥n del TAB -->
            </div>
            {% endfor %}
        </div>
    </div>
    
    










    <!-- Inicio de modales -->


    <!-- Modal: Ajustes de grupo -->
    <div class="modal fade" id="ajustesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-lg modal-dialog-centered">
            <div class="modal-content glassmorphic">
                <div class="modal-header">
                    <h5 class="modal-title">{{ _('Configuraci√≥n del grupo') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Cerrar') }}"></button>
                </div>
                <div class="modal-body">
                    <!-- Advertencia -->
                    <div class="alert alert-warning d-flex align-items-start gap-2 mb-4" role="alert">
                        <i class="bi bi-exclamation-triangle-fill fs-4 text-warning"></i>
                        <div>
                            <strong>{{ _('¬°Atenci√≥n!') }}</strong><br>
                            {{ _('Si modificas la configuraci√≥n del grupo (nombres de alianzas o d√≠as), ') }}<strong>{{ _('se eliminar√°n todos los datos recibidos') }}</strong> {{ _('hasta ahora.') }} 
                            <br>{{ _('No modifiques esta secci√≥n si ya est√°s recibiendo postulaciones.') }}
                        </div>
                    </div>
                
                    <!-- Contenedor con data-* -->
                    <div id="groupSettingsData"
                        data-alliances='{{ alliances_serializable | tojson | safe }}'
                        data-days='{{ days_serializable | tojson | safe }}'>
                    </div>
                
                    <!-- FORMULARIO -->
                    <form method="post" action="/groups/update-settings/{{ group.group_code }}" id="settingsFormModal">
                        <!-- N√∫mero de alianzas -->
                        <div class="mb-4">
                            <label for="numAlliances" class="form-label">{{ _('N√∫mero de alianzas (1 a 12)') }}</label>
                            <select id="numAlliances" name="num_alliances" class="form-select">
                                <option value="">{{ _('Selecciona una opci√≥n') }}</option>
                                {% for i in range(1, 13) %}
                                    <option value="{{ i }}">{{ i }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    
                        <!-- Campos de nombres de alianzas EDIT-->
                        <div id="alliancesContainer" class="mb-4"></div>
                    
                        <!-- N√∫mero de d√≠as -->
                        <div class="mb-4">
                            <label for="numDays" class="form-label">{{ _('N√∫mero de d√≠as a organizar (1 a 4)') }}</label>
                            <select id="numDays" name="num_days" class="form-select">
                                <option value="">{{ _('Selecciona una opci√≥n') }}</option>
                                {% for i in range(1, 5) %}
                                    <option value="{{ i }}">{{ i }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    
                        <!-- Campos de nombres de d√≠as -->
                        <div id="daysContainer" class="mb-4"></div>
                    
                        <!-- Botones -->
                        <div class="text-center d-flex justify-content-center gap-3">
                            <button id="confirmButton" type="submit" class="btn btn-primary" disabled>
                                {{ _('Guardar cambios') }}
                            </button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                {{ _('Cancelar') }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
  


    <!-- Data del grupo -->
    <div id="groupData" class="d-none"
        data-group-code="{{ group.group_code }}"
        data-creator-id="{{ group.creator_id }}"
        data-member-count="{{ group.members | length }}"
        data-current-user-id="{{ current_user.id }}"

        data-error-message="{{ _('Usuario no encontrado, ID incorrecto o no existe.') }}"
        data-error-catch-message1="{{ _('Error de red o parsing:')}}"
        data-error-catch-message2="{{ _('Error de conexi√≥n. Intenta m√°s tarde.')}}"
        data-error-transfer="{{ _('Error al transferir el grupo')}}"
        data-owner-label="{{ _('Due√±o!!')}}"

        data-creator-cant-leave="{{ _('Eres el creador del grupo y no puedes abandonarlo mientras haya otros miembros.') }}"
        data-must-transfer="{{ _('Primero debes ceder el grupo a otro usuario.') }}"
        data-understood="{{ _('Entendido') }}"
        data-only-member="{{ _('Eres el √∫nico miembro del grupo.') }}"
        data-will-delete="{{ _('Si abandonas, el grupo ser√° eliminado autom√°ticamente.') }}"
        data-cancel="{{ _('Cancelar') }}"
        data-leave-delete="{{ _('Abandonar y eliminar grupo') }}"
        data-confirm-leave="{{ _('¬øEst√°s seguro de que deseas abandonar este grupo?') }}"
        data-leave-group="{{ _('Abandonar grupo') }}">

    </div>

    <!-- Modal 1: Gesti√≥n de miembros -->
    <div class="modal fade" id="modalGestionMiembros" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
            <div class="modal-content glassmorphic">
                <div class="modal-header">
                    <h5 class="modal-title">{{ _('Miembros del grupo') }}</h5>

                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <!-- Buscador -->
                    <div class="input-group mb-3">
                        <input type="number" id="inputBuscarID" class="form-control" placeholder="{{ _('Buscar por ID') }}">
                        <button class="btn btn-outline-primary" id="btnBuscarID">üîç {{ _('Buscar') }}</button>
                    </div>

                    <!-- Resultado de b√∫squeda -->
                    <div id="resultadoBusqueda" class="d-none mb-3">
                        <div class="alert alert-info d-flex justify-content-between align-items-center d-none" id="alertSuccess">
                            <span id="nombreUsuarioEncontrado"></span>
                            <button class="btn btn-sm btn-outline-secondary" id="btnVerConfirmarAgregar">{{ _('Agregar editor ') }}‚ûï</button>
                        </div>

                        <div class="alert alert-danger d-flex justify-content-between align-items-center d-none" id="alertError">
                            <span id="usuarioNoEncontrado"></span>
                        </div>
                    </div>

                    <!-- Lista de miembros -->
                    <h6>{{ _('Miembros actuales') }}</h6>
                    <ul class="list-group" id="listaMiembrosGrupo"></ul>

                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancelar') }}</button>
                    <button class="btn btn-primary" id="btnGuardarMiembros">{{ _('Guardar cambios') }}</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal 2: Confirmar agregar -->
    <div class="modal fade" id="modalConfirmarAgregar" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glassmorphic">
          <div class="modal-header">
            <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-target="#modalGestionMiembros" data-bs-toggle="modal">
              ‚Üê
            </button>
            <h5 class="modal-title">{{ _('Confirmar') }}</h5>
          </div>
          <div class="modal-body text-center">
            <p id="usuarioAConfirmar"></p>
            <button class="btn btn-success me-2" id="btnConfirmarAgregar">{{ _('Agregar') }}</button>
            <button class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancelar') }}</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Confirmar transferencia de grupo -->
    <div class="modal fade" id="modalTransferencia" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glassmorphic">
                <div class="modal-header">
                    <h5 class="modal-title">{{ _('Confirmar transferencia de grupo') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Cerrar') }}"></button>
                </div>
                <div class="modal-body text-center">
                    <p>{{ _('¬øEst√°s seguro que deseas transferir el grupo a:') }}</p>
                    <p class="fw-bold" id="usuarioTransferenciaConfirmar"></p>
                    <div class="d-flex justify-content-center gap-2 mt-3">
                        <button class="btn btn-warning" id="btnTransferirGrupo">{{ _('Transferir') }}</button>
                        <button class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancelar') }}</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
  


    <!-- Modal: Confirmar eliminaci√≥n del grupo -->
    <div class="modal fade" id="modalEliminarGrupo" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glassmorphic">
                <div class="modal-header">
                    <h5 class="modal-title text-danger">{{ _('¬øEliminar grupo?') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Cerrar') }}"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">{{ _('Est√°s a punto de eliminar este grupo permanentemente.') }}</p>
                    <p class="text-danger fw-bold">{{ _('Esta acci√≥n no se puede deshacer.') }}</p>
                </div>
                <div class="modal-footer">
                    <form method="POST" action="/groups/delete">
                        <input type="hidden" name="group_code" value="{{ group.group_code }}">
                        <button type="submit" class="btn btn-danger">{{ _('Eliminar definitivamente') }}</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancelar') }}</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
  


  

    <!-- Modal: Confirmaci√≥n de abandono -->
    <div class="modal fade" id="leaveGroupModal" tabindex="-1" aria-labelledby="leaveGroupModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content glassmorphic" id="leaveGroupModalContent">
            <div class="modal-header">
              <h5 class="modal-title" id="leaveGroupModalLabel">{{ _('¬øEst√°s seguro?') }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Cerrar') }}"></button>
            </div>
            <div class="modal-body" id="leaveGroupModalBody">
              <!-- Este contenido se llena din√°micamente con JS -->
            </div>
            <div class="modal-footer" id="leaveGroupModalFooter">
              <!-- Botones din√°micos seg√∫n el caso -->
            </div>
          </div>
        </div>
    </div>

    <!-- Modal para obtener el link -->
    <div class="modal fade" id="modalLinkCita" tabindex="-1" aria-labelledby="modalLinkLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glassmorphic" style="border-radius: 12px;">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLinkLabel">üîó Link para recibir postulaciones</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="mb-2">Comparte este link con los todos los miembros de tu alianza/estado la plataforma se encargar√° de hacer el trabajo</p>

                    <div class="input-group">
                        <input type="text" class="form-control" id="groupLinkInput" readonly
                            value="{{ request.base_url }}public/enviar-disponibilidad/{{ group.group_code }}">
                        <button class="btn btn-outline-secondary" type="button" onclick="copyTextById('groupLinkInput', 'copyLinkToast')">üìã</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast para el link copiado -->
    <div id="copyLinkToast" class="toast-custom">¬°Link copiado al portapapeles!</div>

  
  
    <div id="msgContainer" class="d-none"
        data-alliance-invalid="{{ _('Debe tener exactamente 3 caracteres alfanum√©ricos.') }}"
        data-alianza="{{ _('Alianza') }}"
        data-day-invalid="{{ _('M√°ximo 20 caracteres. Solo letras, n√∫meros y espacios.') }}"
        data-day="{{ _('Nombre del d√≠a. Ej:') }}">
    </div>


</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', path='js/codigo.js') }}"></script>
<script src="{{ url_for('static', path='js/gestion_grupos.js') }}"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const container = document.getElementById("groupSettingsData");
        const alliancesData = JSON.parse(container.dataset.alliances || "[]");
        const daysData = JSON.parse(container.dataset.days || "[]");

        const ajustesModal = document.getElementById('ajustesModal');
        ajustesModal.addEventListener('show.bs.modal', () => {
            initGrupoSettingsEdit(alliancesData, daysData);
        });
    });
</script>

<script>
    function copiarLink() {
        const input = document.getElementById("linkPostulacionInput");
        input.select();
        input.setSelectionRange(0, 99999); // Para m√≥viles
        document.execCommand("copy");

        // Feedback visual (puedes cambiarlo a toast si prefieres)
        alert("Link copiado al portapapeles ‚úÖ");
    }
</script>

<script>
    function toggleLimits(dayId) {
    const switchInput = document.getElementById(`switchLimite-${dayId}`);
    const container = document.getElementById(`limitesContainer-${dayId}`);
    if (switchInput.checked) {
        container.classList.remove("d-none");
    } else {
        container.classList.add("d-none");
    }
}

// Cuando cambia un selector de cupos
function handleLimitChange(dayId) {
    const selects = document.querySelectorAll(`#limitesContainer-${dayId} .limit-selector`);
    let total = 0;

    // Recontar total de cupos fijos definidos
    selects.forEach(select => {
        const val = parseInt(select.value);
        if (!isNaN(val) && val > 0) {
            total += val;
        }
    });

    const remaining = 48 - total;

    // Evitar asignaciones que sobrepasen 48
    if (remaining < 0) {
        alert("‚ö†Ô∏è No puedes asignar m√°s de 48 cupos en total.");
        return;
    }

    // Actualizar selects restantes (m√°ximo permitido din√°mico)
    selects.forEach(select => {
        const currentValue = parseInt(select.value);
        const currentOptions = Array.from(select.options);

        // Limpiar y reconstruir opciones
        select.innerHTML = "";

        // Sin l√≠mite
        const optBlank = document.createElement("option");
        optBlank.value = "";
        optBlank.textContent = "Sin l√≠mite";
        select.appendChild(optBlank);
            
        // Opci√≥n para excluir
        const opt0 = document.createElement("option");
        opt0.value = "0";
        opt0.textContent = "üö´ Excluir esta alianza";
        select.appendChild(opt0);


        // Crear nuevas opciones din√°micas
        const max = (isNaN(currentValue) || currentValue <= 0) ? remaining : remaining + currentValue;
        for (let i = 1; i <= Math.min(max, 48); i++) {
            const opt = document.createElement("option");
            opt.value = i;
            opt.textContent = i;
            if (i === currentValue) {
                opt.selected = true;
            }
            select.appendChild(opt);
        }

        // Restaurar selecci√≥n si era 0 o sin l√≠mite
        if (currentValue === 0) select.value = "0";
        else if (isNaN(currentValue) || currentValue === "") select.value = "";
    });
}
</script>
<script>
    function confirmarGuardarAsignaciones(button) {
        const dayId = button.getAttribute("data-day-id");
        const hasAssignments = button.getAttribute("data-has-assignments") === "true";

        if (hasAssignments) {
            // Mostrar modal de confirmaci√≥n
            const confirmModal = new bootstrap.Modal(document.getElementById(`confirmModal-${dayId}`));
            confirmModal.show();
        } else {
            // Guardar directamente
            guardarAsignaciones(dayId, false);
        }
    }

</script>
{% endblock %}
